<!--
    This encapsulates the standard logic for capturing the provider, date, and location of an encounter
    The following sections can be overridden from the default configurations that are shown:

    <span subform-parameter="encounter-provider-widget">
        <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05" required="true"/>
    </span>

    <span subform-parameter="encounter-location-widget">
        <encounterLocation default="SessionAttribute:emrContext.sessionLocationId" tags="Consult Note Location"/>
    </span>

    <span subform-parameter="encounter-date-widget">
        <encounterDate id="encounterDate" default="now" />
    </span>
-->
<div>
    <ifMode mode="VIEW" include="false">

        <style type="text/css">
            #who-when-where {
                margin-bottom: 6px;
                border-bottom: 1px solid #ccc;
            }
            #who-when-where p {
                display: inline-block;
                padding-right: 20px;
            }
            #where > input[type=text] {
                display: inline-block;
            }
            .field-error {
                color: #ff6666;
                font-size: 1.1em;
                display: block;
            }
        </style>

        <!-- users with retroConsultNote privilege can edit provider, location, and date for both retro and active visits -->
        <includeIf velocityTest="$user.hasPrivilege('Task: emr.retroConsultNote')">
            <div id="who-when-where">
                <p id="who">
                    <label><uimessage code="emr.patientDashBoard.providerRequired"/></label>
                    <span subform-parameter="encounter-provider-widget">
                        <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05" required="true"/>
                    </span>
                </p>
                <p id="where">
                    <label><uimessage code="emr.locationRequired"/></label>
                    <span subform-parameter="encounter-location-widget">
                        <encounterLocation default="SessionAttribute:emrContext.sessionLocationId" tags="Consult Note Location"/>
                    </span>
                </p>
                <p id="when">
                    <label><uimessage code="emr.patientDashBoard.date"/></label>
                    <span subform-parameter="encounter-date-widget">
                        <encounterDate id="encounterDate" default="now" />
                    </span>
                </p>
            </div>
        </includeIf>
        <!-- users with retroConsultNoteThisProviderOnly can edit location and date (but not provider) for retro visits -->
        <includeIf velocityTest="$user.hasPrivilege('Task: emr.retroConsultNoteThisProviderOnly') and !($user.hasPrivilege('Task: emr.retroConsultNote')) and (!$visit.open)">
            <div style="display:none">
                <span subform-parameter="encounter-provider-widget">
                    <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05" required="true"/>
                </span>
            </div>

            <div id="who-when-where">
                <p id="who">
                    <label><uimessage code="emr.patientDashBoard.provider"/></label>
                    <span><lookup expression="user.person.personName" /></span>
                </p>
                <p id="where">
                    <label><uimessage code="emr.locationRequired"/></label>
                    <span subform-parameter="encounter-location-widget">
                        <encounterLocation default="SessionAttribute:emrContext.sessionLocationId" tags="Consult Note Location"/>
                    </span>
                </p>
                <p id="when">
                    <label><uimessage code="emr.patientDashBoard.date"/></label>
                    <span subform-parameter="encounter-date-widget">
                        <encounterDate id="encounterDate" default="now" />
                    </span>
                </p>
            </div>

        </includeIf>
        <!-- all users that don't have either retro privilege, or those with retro-this-provider-only but with an active visit, can only edit location -->
        <!-- all users that don't have either retro privilege, or those with retro-this-provider-only but with an active visit, can only edit location -->
        <includeIf velocityTest="(!$user.hasPrivilege('Task: emr.retroConsultNoteThisProviderOnly') and !$user.hasPrivilege('Task: emr.retroConsultNote')) or ($user.hasPrivilege('Task: emr.retroConsultNoteThisProviderOnly') and !$user.hasPrivilege('Task: emr.retroConsultNote') and $visit.open)">
            <div style="display:none">
                <span subform-parameter="encounter-provider-widget">
                    <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05" required="true"/>
                </span>
                <span subform-parameter="encounter-date-widget">
                    <encounterDate id="encounterDate" default="now"/>
                </span>
            </div>
            <div id="who-when-where">
                <table id="who-where-when-view">
                    <tr>
                        <td>
                            <label>
                                <uimessage code="emr.patientDashBoard.provider"/>
                            </label>
                            <span>
                                <lookup complexExpression="#if($encounter) $ui.format($encounter.provider) #else $ui.format($user.person) #end"/>
                            </span>
                        </td>
                        <td>
                            <label>
                                <uimessage code="emr.locationRequired"/>
                            </label>
                            <span subform-parameter="encounter-location-widget">
                                <encounterLocation default="SessionAttribute:emrContext.sessionLocationId" tags="Consult Note Location"/>
                            </span>
                        </td>
                        <td>
                            <label>
                                <uimessage code="emr.patientDashBoard.date"/>
                            </label>
                            <span>
                                <lookup complexExpression="#if($encounter) $ui.format($fn.startOfDay($encounter.encounterDatetime)) #else $ui.format($fn.startOfDay($formGeneratedDatetime)) #end"/>
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
        </includeIf>
    </ifMode>
</div>